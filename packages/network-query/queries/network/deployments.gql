# Copyright 2020-2022 SubQuery Pte Ltd authors & contributors
# SPDX-License-Identifier: Apache-2.0

fragment DeploymentIndexerFields on DeploymentIndexer {
  id
  indexerId
  deploymentId
  blockHeight
  timestamp
  status
  indexer {
    metadata
  }
}

fragment DeploymentIndexerNodeFields on DeploymentIndexer {
  ...DeploymentIndexerFields
  deployment {
    id
    project {
      id
      metadata
    }
  }
}

query GetDeployment($deploymentId: String!) {
  deployment(id: $deploymentId) {
    id
    version
    project {
      id
      metadata
    }
  }
}

query GetDeploymentIndexers(
  $first: Int = 20
  $offset: Int
  $deploymentId: String!
  $orderby: [DeploymentIndexersOrderBy!] = LAST_EVENT_ASC
  $search: Boolean! = false
  $indexerId: String! = ""
) {
  deploymentIndexers(
    first: $first
    offset: $offset
    orderBy: $orderby
    filter: { deploymentId: { equalTo: $deploymentId }, status: { notEqualTo: TERMINATED } }
  ) @skip(if: $search) {
    totalCount
    nodes {
      ...DeploymentIndexerFields
    }
  }

  deploymentIndexersBySearch: deploymentIndexers(
    first: $first
    offset: $offset
    orderBy: $orderby
    filter: {
      deploymentId: { equalTo: $deploymentId }
      status: { notEqualTo: TERMINATED }
      indexerId: { equalTo: $indexerId }
    }
  ) @include(if: $search) {
    totalCount
    nodes {
      ...DeploymentIndexerFields
    }
  }
}

query GetDeploymentIndexer($indexerAddress: String!, $deploymentId: String!) {
  deploymentIndexers(
    filter: { indexerId: { equalTo: $indexerAddress }, deploymentId: { equalTo: $deploymentId } }
  ) {
    totalCount
    nodes {
      ...DeploymentIndexerFields
    }
  }
}

query GetDeploymentIndexersByIndexer($indexerAddress: String!) {
  deploymentIndexers(filter: { indexerId: { equalTo: $indexerAddress } }) {
    totalCount
    pageInfo {
      startCursor
      endCursor
      hasNextPage
    }
    nodes {
      ...DeploymentIndexerFields
      deployment {
        id
        project {
          id
          metadata
        }
      }
    }
  }
}

query GetDeploymentIndexersDeploymentByIndexer($indexerAddress: String!) {
  deploymentIndexers(filter: { indexerId: { equalTo: $indexerAddress } }) {
    nodes {
      ...DeploymentIndexerNodeFields
    }
  }
}

query GetAcceptedOffers($address: String!, $offerId: String!) {
  acceptedOffers(filter: { indexerId: { equalTo: $address }, offerId: { equalTo: $offerId } }) {
    totalCount
    nodes {
      id
    }
  }
}
